// Minimal proto definitions for Tesla signed routable messages.
// Extracted from Tesla Vehicle Command Protocol + Matthew1471's energy device extensions.
// Only includes what's needed for RSA-signed TEDAPI over LAN (/tedapi/v1r).

syntax = "proto3";
package VehicleCommand;

// ============================================================
// Signature Tags (TLV encoding for signing)
// ============================================================
enum Tag {
    TAG_SIGNATURE_TYPE  = 0;
    TAG_DOMAIN          = 1;
    TAG_PERSONALIZATION = 2;
    TAG_EPOCH           = 3;
    TAG_EXPIRES_AT      = 4;
    TAG_COUNTER         = 5;
    TAG_CHALLENGE       = 6;
    TAG_FLAGS           = 7;
    TAG_REQUEST_HASH    = 8;
    TAG_FAULT           = 9;
    TAG_END             = 255;
}

enum SignatureType {
    SIGNATURE_TYPE_AES_GCM                = 0;
    SIGNATURE_TYPE_AES_GCM_PERSONALIZED   = 5;
    SIGNATURE_TYPE_HMAC                   = 6;
    SIGNATURE_TYPE_RSA                    = 7;
    SIGNATURE_TYPE_HMAC_PERSONALIZED      = 8;
    SIGNATURE_TYPE_AES_GCM_RESPONSE       = 9;
}

// ============================================================
// Domains
// ============================================================
enum Domain {
    DOMAIN_BROADCAST        = 0;
    DOMAIN_VEHICLE_SECURITY = 2;
    DOMAIN_INFOTAINMENT     = 3;
    DOMAIN_ENERGY_DEVICE    = 7;
}

// ============================================================
// Destination
// ============================================================
message Destination {
    oneof sub_destination {
        Domain domain          = 1;
        bytes  routing_address = 2;
    }
}

// ============================================================
// Signature messages
// ============================================================
message KeyIdentity {
    oneof identity_type {
        bytes  public_key = 1;
        uint32 handle     = 3;
    }
}

message RsaSignatureData {
    fixed32 expires_at = 1;
    bytes  signature  = 2;
}

message SignatureData {
    KeyIdentity signer_identity = 1;
    oneof sig_type {
        // Field numbers match Tesla's extended energy-device proto
        RsaSignatureData rsa_data = 7;
    }
}

// ============================================================
// Operation status (for response parsing)
// ============================================================
enum OperationStatus_E {
    OPERATIONSTATUS_OK    = 0;
    OPERATIONSTATUS_WAIT  = 1;
    OPERATIONSTATUS_ERROR = 2;
}

enum MessageFault_E {
    MESSAGEFAULT_ERROR_NONE                              = 0;
    MESSAGEFAULT_ERROR_BUSY                              = 1;
    MESSAGEFAULT_ERROR_TIMEOUT                           = 2;
    MESSAGEFAULT_ERROR_UNKNOWN_KEY_ID                    = 3;
    MESSAGEFAULT_ERROR_INACTIVE_KEY                      = 4;
    MESSAGEFAULT_ERROR_INVALID_SIGNATURE                 = 5;
    MESSAGEFAULT_ERROR_INVALID_TOKEN_OR_COUNTER          = 6;
    MESSAGEFAULT_ERROR_INSUFFICIENT_PRIVILEGES           = 7;
    MESSAGEFAULT_ERROR_INVALID_DOMAINS                   = 8;
    MESSAGEFAULT_ERROR_INVALID_COMMAND                   = 9;
    MESSAGEFAULT_ERROR_DECODING                          = 10;
    MESSAGEFAULT_ERROR_INTERNAL                          = 11;
    MESSAGEFAULT_ERROR_WRONG_PERSONALIZATION             = 12;
    MESSAGEFAULT_ERROR_BAD_PARAMETER                     = 13;
    MESSAGEFAULT_ERROR_KEYCHAIN_IS_FULL                  = 14;
    MESSAGEFAULT_ERROR_INCORRECT_EPOCH                   = 15;
    MESSAGEFAULT_ERROR_IV_INCORRECT_LENGTH               = 16;
    MESSAGEFAULT_ERROR_TIME_EXPIRED                      = 17;
    MESSAGEFAULT_ERROR_NOT_PROVISIONED_WITH_IDENTITY     = 18;
    MESSAGEFAULT_ERROR_COULD_NOT_HASH_METADATA           = 19;
    MESSAGEFAULT_ERROR_TIME_TO_LIVE_TOO_LONG             = 20;
    MESSAGEFAULT_ERROR_REMOTE_ACCESS_DISABLED            = 21;
    MESSAGEFAULT_ERROR_REMOTE_SERVICE_ACCESS_DISABLED    = 22;
    MESSAGEFAULT_ERROR_COMMAND_REQUIRES_ACCOUNT_CREDENTIALS = 23;
}

message MessageStatus {
    OperationStatus_E operation_status      = 1;
    MessageFault_E    signed_message_fault  = 2;
}

// ============================================================
// RoutableMessage â€” the top-level wrapper for /tedapi/v1r
// ============================================================
message RoutableMessage {
    reserved 1 to 5;
    reserved 11;
    reserved 16 to 40;

    Destination   to_destination   = 6;
    Destination   from_destination = 7;

    oneof payload {
        bytes protobuf_message_as_bytes = 10;
        bytes session_info              = 15;
    }

    MessageStatus signed_message_status = 12;

    oneof sub_sigData {
        SignatureData signature_data = 13;
    }

    bytes  request_uuid = 50;
    bytes  uuid         = 51;
    uint32 flags        = 52;
}
